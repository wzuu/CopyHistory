# 文件记录管理

<cite>
**本文档引用的文件**   
- [clipboard_db.py](file://clipboard_db.py)
- [clipboard_gui.py](file://clipboard_gui.py)
</cite>

## 目录
1. [save_file_record方法的事务处理机制](#save_file_record方法的事务处理机制)
2. [get_file_records方法的分页与排序实现](#get_file_records方法的分页与排序实现)
3. [delete_file_record方法的实现细节](#delete_file_record方法的实现细节)
4. [文件记录的增删改查操作示例](#文件记录的增删改查操作示例)

## save_file_record方法的事务处理机制

`save_file_record`方法负责将文件元数据保存到数据库中，包括原始路径、保存路径、文件名、大小、类型和MD5哈希值。该方法通过事务处理机制确保数据的一致性和完整性。

当调用`save_file_record`方法时，首先会创建一个数据库连接并获取游标对象。然后，使用本地时间作为时间戳，并尝试将文件记录插入到`file_records`表中。如果插入成功，返回新创建记录的ID。

关键的事务处理机制体现在对重复MD5哈希值的处理上。当检测到具有相同MD5哈希值的记录已存在时（触发`sqlite3.IntegrityError`异常），方法不会简单地拒绝插入，而是执行更新操作。具体来说，它会更新该记录的原始路径和时间戳字段，并将引用计数`number`增加1。这种设计避免了重复存储相同内容的文件，同时保留了文件的历史引用信息。

整个操作在一个数据库事务中完成，确保了原子性。如果插入或更新操作成功，事务会被提交；如果发生任何错误，事务会被回滚，保持数据库的一致状态。

**Section sources**
- [clipboard_db.py](file://clipboard_db.py#L152-L183)

## get_file_records方法的分页与排序实现

`get_file_records`方法实现了文件记录的分页和动态排序功能。该方法支持根据不同的字段进行排序，并可以通过`reverse`参数控制排序方向。

方法的排序实现基于`sort_by`参数动态构建SQL查询语句。当`sort_by`参数为"filename"时，按文件名排序；为"file_size"时，按文件大小排序；为"file_type"时，按文件类型排序；为"number"时，按引用计数排序；其他情况下默认按时间戳排序。排序方向由`reverse`参数决定，`True`表示降序（最新的在前），`False`表示升序。

分页功能通过`limit`和`offset`参数实现。当`limit`参数不为`None`时，查询语句会包含`LIMIT ? OFFSET ?`子句，从而实现分页效果。这使得应用程序可以按需加载指定数量的记录，提高性能和用户体验。

**Section sources**
- [clipboard_db.py](file://clipboard_db.py#L223-L261)

## delete_file_record方法的实现细节

`delete_file_record`方法负责从数据库中删除指定的文件记录，同时维护数据完整性。该方法的实现强调了数据完整性的维护，确保数据库状态与文件系统状态保持一致。

方法首先通过记录ID从`file_records`表中查询对应的`saved_path`。如果找到记录，则执行两个关键操作：首先调用`delete_file_record`方法从数据库中删除该记录；然后调用`check_and_delete_file`方法检查并删除对应的物理文件（如果该文件不再被其他记录引用）。

这种设计确保了当数据库中的记录被删除时，相关的物理文件也会被清理，避免了磁盘空间的浪费。同时，通过检查文件引用计数，可以防止删除仍被其他记录引用的文件，维护了数据的完整性。

**Section sources**
- [clipboard_gui.py](file://clipboard_gui.py#L839-L887)

## 文件记录的增删改查操作示例

以下代码示例展示了文件记录的增删改查操作：

```python
# 创建数据库实例
db = ClipboardDatabase()

# 增加文件记录
record_id = db.save_file_record(
    original_path="C:\\Users\\User\\Documents\\example.txt",
    saved_path="clipboard_files\\documents\\2024-01-01\\example_abc123.txt",
    filename="example.txt",
    file_size=1024,
    file_type="documents",
    md5_hash="abc123def456"
)

# 查询文件记录（按时间降序，获取前10条）
records = db.get_file_records(limit=10, sort_by="timestamp", reverse=True)

# 删除文件记录
db.delete_file_record(record_id)
```

这些操作展示了如何使用`ClipboardDatabase`类的方法来管理文件记录，包括保存新记录、查询记录和删除记录。

**Section sources**
- [clipboard_db.py](file://clipboard_db.py#L152-L183)
- [clipboard_db.py](file://clipboard_db.py#L223-L261)
- [clipboard_gui.py](file://clipboard_gui.py#L839-L887)