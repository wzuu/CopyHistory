# 附录

<cite>
**本文档中引用的文件**   
- [run_clipboard_manager.py](file://run_clipboard_manager.py)
- [clipboard_db.py](file://clipboard_db.py)
- [convert_to_ico.py](file://convert_to_ico.py)
- [setup.py](file://setup.py)
- [check_db.py](file://check_db.py)
- [cleanup_duplicates.py](file://cleanup_duplicates.py)
- [view_clipboard_history.py](file://view_clipboard_history.py)
- [.gitignore](file://.gitignore)
- [build_exe.py](file://build_exe.py)
</cite>

## 目录
1. [源文件功能说明](#源文件功能说明)
2. [外部依赖列表](#外部依赖列表)
3. [.gitignore排除规则](#gitignore排除规则)
4. [测试脚本用途](#测试脚本用途)
5. [构建配置说明](#构建配置说明)
6. [贡献指南](#贡献指南)
7. [版本历史记录模板](#版本历史记录模板)

## 源文件功能说明

### run_clipboard_manager.py（主入口）
作为剪贴板管理器的主入口脚本，该文件负责同时运行剪贴板监控器和GUI界面。它实现了程序单实例运行检查，通过互斥锁防止重复启动。当程序已在运行时，会尝试激活已存在的窗口。该脚本创建剪贴板管理器实例，在独立线程中启动剪贴板监控循环，并初始化GUI应用，将主窗口隐藏并显示系统托盘图标。

**Section sources**
- [run_clipboard_manager.py](file://run_clipboard_manager.py#L1-L71)

### clipboard_db.py（数据库操作）
该模块提供剪贴板数据库的完整管理功能。它定义了`ClipboardDatabase`类，负责初始化数据库结构，包括文本记录表、文件记录表和设置表。支持保存和检索文本及文件记录，实现基于MD5哈希的重复内容检测和合并。提供记录搜索、统计信息获取、记录删除等操作。数据库设计支持动态字段添加，确保向后兼容性，并实现了过期记录自动清理功能。

**Section sources**
- [clipboard_db.py](file://clipboard_db.py#L1-L455)

### convert_to_ico.py（图标转换工具）
该工具脚本用于将JPG图片转换为ICO图标文件。它使用Pillow库打开JPG图片，转换为支持透明度的RGBA模式，并调整大小至指定尺寸（默认32x32）。然后保存为ICO格式文件。脚本包含主运行逻辑，会检查输入文件是否存在，并执行转换操作，生成指定名称的ICO文件，同时创建不同尺寸的图标文件以满足不同需求。

**Section sources**
- [convert_to_ico.py](file://convert_to_ico.py#L1-L48)

## 外部依赖列表

项目依赖以下外部库，其版本要求如下：

- **tkinter**: Python标准库中的GUI工具包，用于创建图形用户界面。无需单独安装，随Python一起提供。
- **pywin32**: 提供对Windows API的访问，用于实现剪贴板操作、窗口管理和互斥锁等功能。需要通过`pip install pywin32`安装。
- **Pillow**: Python图像处理库，用于图标转换和图像操作。需要通过`pip install pillow`安装。
- **pystray**: 用于创建系统托盘图标，允许程序在后台运行时通过托盘图标进行交互。需要通过`pip install pystray`安装。
- **cx_Freeze**: 用于将Python脚本打包为可执行文件。在setup.py和build_exe.py中配置，将项目打包为Windows可执行程序。

这些依赖在setup.py和build_exe.py的配置中明确指定，确保打包时包含必要的模块。

**Section sources**
- [setup.py](file://setup.py#L22-L30)
- [build_exe.py](file://build_exe.py#L22-L30)

## .gitignore排除规则

.gitignore文件定义了不应纳入版本控制的文件和目录模式，主要包括：

- `__pycache__/`: Python编译的字节码缓存目录，包含.pyc文件，可由源代码重新生成。
- `*.pyc`: Python编译的字节码文件，属于临时文件，不应提交到版本库。
- `clipboard_files/`: 存储剪贴板中复制的文件的目录，包含用户数据，大小可能很大且具有个人隐私性。
- `clipboard_history.db`: 剪贴板历史记录数据库文件，存储用户的剪贴板内容，属于敏感用户数据。
- `*.db`: 通用数据库文件模式，防止意外提交其他数据库文件。
- `build/`: cx_Freeze打包生成的构建输出目录。
- `dist/`: 打包分发目录。
- `*.exe`: 生成的Windows可执行文件，可由源代码重新构建。

这些排除规则确保了版本库的整洁性，保护了用户隐私数据，并避免了可再生文件的重复存储。

**Section sources**
- [.gitignore](file://.gitignore)

## 测试脚本用途

### check_db.py（数据库验证）
该脚本用于检查数据库内容的完整性和正确性。它连接到clipboard_history.db数据库，查询最近的带有MD5哈希的文本记录，验证MD5功能是否正常工作。同时，它会查找具有相同MD5值的重复记录，帮助识别去重逻辑是否按预期工作。此脚本是调试数据库状态和验证数据完整性的重要工具。

**Section sources**
- [check_db.py](file://check_db.py#L1-L31)

### cleanup_duplicates.py（去重清理）
该脚本专门用于清理数据库中重复的MD5记录。它查找所有具有相同MD5哈希的文本记录，保留时间最新的记录作为主记录，将其他重复记录的计数累加到主记录上，然后删除这些重复记录。此过程优化了数据库存储，减少了冗余数据，同时保持了内容出现次数的统计准确性。

**Section sources**
- [cleanup_duplicates.py](file://cleanup_duplicates.py#L1-L67)

### view_clipboard_history.py（命令行查看器）
这是一个独立的命令行工具，用于查看剪贴板历史记录。它创建数据库实例，获取最近的文本和文件记录，并以格式化的文本形式输出。显示内容包括记录类型、内容预览、文件大小、时间戳等信息。同时提供统计信息，如记录总数和文件总大小。此脚本可用于快速检查剪贴板历史，无需启动完整的GUI界面。

**Section sources**
- [view_clipboard_history.py](file://view_clipboard_history.py#L1-L75)

## 构建配置说明

### setup.py中的包元数据
setup.py文件定义了项目的打包配置，使用cx_Freeze将Python脚本打包为Windows可执行文件。包元数据包括：
- **name**: "剪贴板管理器" - 项目名称
- **version**: "1.0" - 当前版本号
- **description**: "剪贴板历史记录管理工具" - 项目描述

### install_requires定义
虽然项目使用setup.py而非标准的setup.py配置，但其依赖管理通过`packages`和`includes`参数实现：
- **packages**: 包含tkinter、sqlite3、hashlib、win32clipboard、win32con、PIL、pystray等必需的Python包。
- **includes**: 明确包含项目内部模块clipboard_db、clipboard_gui和clipboard_content_detector。
- **include_files**: 指定需要包含的资源文件，如图标文件(2.ico, icon.ico)和数据库文件模板(clipboard_history.db)。

打包配置定义了三个可执行文件：主GUI应用"剪贴板管理器.exe"、命令行查看器"查看剪贴板历史.exe"和内容检测器"剪贴板内容检测器.exe"，分别对应不同的启动脚本和应用类型（GUI或控制台）。

**Section sources**
- [setup.py](file://setup.py#L78-L84)
- [build_exe.py](file://build_exe.py#L75-L81)

## 贡献指南

### 代码风格
- 遵循PEP 8代码风格指南，保持代码整洁和一致性。
- 使用中文注释，确保代码逻辑清晰易懂。
- 函数和方法应有清晰的文档字符串，说明其功能、参数和返回值。
- 变量和函数命名应具有描述性，使用英文单词，避免缩写。

### 提交规范
- 提交信息应清晰描述更改内容，使用中文。
- 小的修复和改进可以直接提交。
- 重大功能变更应先创建议题讨论，达成共识后再实施。
- 确保提交的代码经过测试，不会破坏现有功能。

### 测试要求
- 修改数据库相关功能时，应使用check_db.py和debug_md5.py验证数据完整性。
- 添加新功能后，应确保view_clipboard_history.py能正确显示相关记录。
- 在提交前，应运行cleanup_duplicates.py确保去重逻辑正常工作。
- 任何影响用户界面的更改，都应在实际环境中测试GUI的响应性和用户体验。

## 版本历史记录模板

```markdown
## 版本 1.1.0 (2023-XX-XX)
### 新功能
- 添加了记录保存天数设置，支持自动清理过期记录
- 实现了悬浮图标功能，可从屏幕任意位置快速访问
- 增加了开机自启设置选项

### 改进
- 优化了数据库查询性能，添加了MD5哈希索引
- 改进了GUI界面布局，提升用户体验
- 增强了错误处理机制，提高程序稳定性

### 修复
- 修复了在某些情况下程序无法正确检测到已运行实例的问题
- 修正了文件记录中路径处理的潜在错误
- 解决了长时间运行后内存占用逐渐增加的问题

## 版本 1.0.0 (2023-XX-XX)
- 初始发布版本
- 实现剪贴板文本和文件记录功能
- 提供图形用户界面和系统托盘集成
- 支持基于MD5的重复内容检测和合并
```